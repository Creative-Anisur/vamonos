<html><head>

    <meta id="meta" name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />

    <link rel="stylesheet" href="../lib/vamonos.css">
    <link rel="stylesheet" href="../lib/vamonos-demos.css">
    <script type="text/javascript" src="../lib/vamonos-all.js"></script>

    <style type="text/css">
    svg {
        border: 2px solid black;
    }

    .vertex {
        fill: #eee;
        stroke: #888;
        stroke-width: 1;
    }

    .vertex-contents {
        font-size: .8em;
        font-weight: bold;
    }

    .vertex-ne-label, .vertex-nw-label {
        font-weight: bold;
    }

    .vertex-sw-label {
        font-style: italic;
    }

    .done {
        background: #ddd;
    }

    .color-white {
        background: white;
    }

    .color-gray {
        background: #888;
    }

    .color-black {
        background: black;
    }

    .color-black .vertex-contents, .color-gray .vertex-contents {
        color: white;
    }

    line.edge {
        stroke: #cccccc;
        stroke-width: 4;
    }

    text.edge-label-text {
        font-family: sans-serif;
        font-size: .8em;
    }

    body {
        text-align: center;
    }
    </style>

</head><body>

    <h1>D3 Prototype</h1>

    <table id='graph'>

        <tr><td>
            <ol>
                <li>bring dragged elements to top</li>
                <li>prevent dragging outside svg</li>
                <li>maybe tooltips with vertex info</li>
                <li>integrate d3 in graph display widget</li>
            </ol>
        </td></tr>

    </table>


</body>
<script type="text/javascript">

var g = new Vamonos.DataStructure.Graph({
    vertices: [
        {id: "v0", x: 17,  y: 10},
        {id: "v1", x: 98,  y: 10},
        {id: "v2", x: 176, y: 13},
        {id: "v3", x: 15,  y: 78},
        {id: "v4", x: 100, y: 80},
        {id: "v5", x: 182, y: 80},
        {id: "v6", x: 15,  y: 138},
        {id: "v7", x: 100, y: 140},
        {id: "v8", x: 182, y: 140},
    ],
    edges: [
        {source: 'v0',target: 'v4', w:1},
        {source: 'v1',target: 'v2', w:2},
        {source: 'v1',target: 'v4', w:5},
        {source: 'v3',target: 'v4', w:3},
        {source: 'v3',target: 'v6', w:1},
        {source: 'v4',target: 'v8', w:10},
        {source: 'v5',target: 'v8', w:2},
        {source: 'v6',target: 'v7', w:3},
        {source: 'v7',target: 'v8', w:2},
    ]
});

var vertexWidth = 20;
var vertexHeight = 15;
var contWidth = 250;
var contHeight = 200;

showGraph({ container: "graph", graph: g });

function showGraph(args){
    var g = args.graph;
    var contId = args.container;

    var cont = d3.selectAll("#" + contId)
        .attr("class", "vamonos")
        .append("tr")
        .append("td")
        .append("div")
        .append("svg")
        .attr("height", contHeight)
        .attr("width", contWidth)
        .append("g")
        .attr("transform", "translate(20,20)"); // left and top border padding

    var edges = cont.selectAll("g.edge")
        .data(g.getEdges())
        .enter()
        .append("g")
        .attr("class", "edge");

    edges.append("line")
        .call(setEdgePos)
        .attr("class", "edge");

    edges.append("text")
        .call(setEdgeLabelPos)
        .attr("class", "edge-label-text")
        .text(function(d){ return d.w })

    var vertices = cont.selectAll("g.vertex")
        .data(g.getVertices())
        .enter()
        .append("g");

    vertices.attr("transform", trans)
        .append("ellipse")
        .attr("class", "vertex")
        .attr("cx", 0)
        .attr("cy", 0)
        .attr("rx", vertexWidth)
        .attr("ry", vertexHeight)

    vertices.append("text")
        .attr("x", -4)
        .attr("y", 4)
        .attr("class", "vertex-contents")
        .text(function(d){ return d.name });

    function trans(d){
        return "translate(" + [ d.x, d.y ] + ")"
    }

    function setEdgePos(e){
        e.attr("x1", function(d){ return g.vertex(d.source).x })
         .attr("y1", function(d){ return g.vertex(d.source).y })
         .attr("x2", function(d){ return g.vertex(d.target).x })
         .attr("y2", function(d){ return g.vertex(d.target).y })
        return e
    }

    function setEdgeLabelPos(e){
        e.attr("x", function(d){ return Math.floor((d.source.x + d.target.x) / 2) - 4 })
         .attr("y", function(d){ return Math.floor((d.source.y + d.target.y) / 2) + 5 })
        return e
    }

    function dragmove(d, i){
        d.x = d3.event.x;
        d.y = d3.event.y;
        d3.select(this).attr("transform", trans);
        edges.selectAll("line.edge").call(setEdgePos);
        edges.selectAll("text.edge-label-text").call(setEdgeLabelPos);
    }

    var drag = d3.behavior.drag()
                 .on("drag", dragmove);

    vertices.call(drag);
}

</script></html>
