<html><head>

    <meta id="meta" name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />

    <link rel="stylesheet" href="../lib/vamonos.css">
    <link rel="stylesheet" href="../lib/vamonos-demos.css">
    <script type="text/javascript" src="../lib/vamonos-all.js"></script>

    <style type="text/css">
    .vertex {
        fill: #eee;
        stroke: #888;
        stroke-width: 1;
    }

    .vertex-contents {
        font-size: .8em;
        font-weight: bold;
    }

    .vertex-ne-label, .vertex-nw-label {
        font-weight: bold;
    }

    .vertex-sw-label {
        font-style: italic;
    }

    .done {
        background: #ddd;
    }

    .color-white {
        background: white;
    }

    .color-gray {
        background: #888;
    }

    .color-black {
        background: black;
    }

    .color-black .vertex-contents, .color-gray .vertex-contents {
        color: white;
    }

    line.edge {
        stroke: #cccccc;
        stroke-width: 4;
    }

    text.edge-label-text {
        font-family: sans-serif;
        font-size: .8em;
    }

    body {
        text-align: center;
    }
    </style>

</head><body>

    <h1>D3 Prototype</h1>

    <table id='graph'>

        <tr><td>
            <ol>
                <li>draw a graph using graph datastructure<br></li>
                <li>use groups for all node related things? - labels, pop-ups</li>
                <li>add edge labels - again groups?</li>
                <li>draggablilty - ticks?</li>
                <li>integrate d3 in graph display widget</li>
            </ol>
        </td></tr>

    </table>

    <p>
        Maybe vertices and edges should be represented as closures to
        be called on drag events and stuff.<br>

        Like, when you call an edge it gets drawn?
    </p>

</body>
<script type="text/javascript">
var g = new Vamonos.DataStructure.Graph({
    vertices: [
        {id: "v0", x: 17,  y: 10},
        {id: "v1", x: 98,  y: 10},
        {id: "v2", x: 176, y: 13},
        {id: "v3", x: 15,  y: 78},
        {id: "v4", x: 100, y: 80},
        {id: "v5", x: 182, y: 80},
        {id: "v6", x: 15,  y: 138},
        {id: "v7", x: 100, y: 140},
        {id: "v8", x: 182, y: 140},
    ],
    edges: [
        {source: 'v0',target: 'v4', w:1},
        {source: 'v1',target: 'v2', w:2},
        {source: 'v1',target: 'v4', w:5},
        {source: 'v3',target: 'v4', w:3},
        {source: 'v3',target: 'v6', w:1},
        {source: 'v4',target: 'v8', w:10},
        {source: 'v5',target: 'v8', w:2},
        {source: 'v6',target: 'v7', w:3},
        {source: 'v7',target: 'v8', w:2},
    ]
});

var width = 20;
var height = 15;

showGraph({ container: "graph", graph: g });

function showGraph(args){
    var g = args.graph;
    var contId = args.container;

    d3.selectAll("#" + contId)
      .attr("class", "vamonos")
      .append("tr")
      .append("td")
      .append("div")
      .append("svg")
      .attr("height", 200)
      .attr("width", 250)
      .append("g")
      .attr("transform", "translate(20,20)") // left and top border padding
      .call(drawEdges, g)
      .call(drawVertices, g);
}

function drawEdges(selector, graph){
    var groups = selector.selectAll("g.edge")
        .data(graph.getEdges())
        .enter()
        .append("g")
        .attr("class", "edge");

    var edges = groups.append("line")
        .attr("x1", function(d){ return graph.vertex(d.source).x })
        .attr("y1", function(d){ return graph.vertex(d.source).y })
        .attr("x2", function(d){ return graph.vertex(d.target).x })
        .attr("y2", function(d){ return graph.vertex(d.target).y })
        .attr("class", "edge");

    var labels = groups.append("text")
        .attr("x", function(d){
            return Math.floor((d.source.x + d.target.x) / 2) - 4
        })
        .attr("y", function(d){
            return Math.floor((d.source.y + d.target.y) / 2) + 5
        })
        .text(function(d){ return d.w })
        .attr("class", "edge-label-text")

    return selector;
}

function drawVertices(selector, graph){
    var groups = selector.selectAll("g.vertex")
        .data(graph.getVertices())
        .enter()
        .append("g");

    function transVertex(vtx){
        return "translate(" + [ vtx.x, vtx.y ] + ")";
    }

    var drag = d3.behavior.drag()
      .on("drag", function(d,i){
        d.x += d3.event.dx;
        d.y += d3.event.dy;
        d3.select(this).attr("transform", function(d,i){
            return "translate(" + [ d.x, d.y ] + ")"
        })
    });

    groups.attr("transform", transVertex)
        .append("ellipse")
        .attr("class", "vertex")
        .attr("cx", 0)
        .attr("cy", 0)
        .attr("rx", width)
        .attr("ry", height)

    groups.append("text")
        .attr("x", -4)
        .attr("y", 4)
        .attr("class", "vertex-contents")
        .text(function(d){ return d.name });

    groups.call(drag);

    return selector;
}

</script></html>
